#!/usr/bin/env php
<?php

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Output\ConsoleOutput;
use Infira\Error\Handler;

if (file_exists(__DIR__ . '/../../../autoload.php'))
{
	require __DIR__ . '/../../../autoload.php';
}
else
{
	require __DIR__ . '/../vendor/autoload.php';
}

function br2nl(string $str)
{
	return str_replace(['<br />', '<br>', '< br>'], "\n", $str);
}

define("KLAHVIK_PATH", realpath(__DIR__ . '/../') . '/');

$out     = new ConsoleOutput();
$config  = ["errorLevel"           => -1,//-1 means all erors, see https://www.php.net/manual/en/function.error-reporting.php
            "env"                  => "dev", //dev,stable (stable env does not display full errors erros
            "debugBacktraceOption" => DEBUG_BACKTRACE_IGNORE_ARGS];
$Handler = new Handler($config);

try
{
	$app = new Application('klahvik');
	$app->add(new \Infira\Klahvik\console\Db);
	$app->add(new \Infira\Klahvik\console\Data);
	$app->add(new \Infira\Klahvik\console\gws\Db);
	$app->add(new \Infira\Klahvik\console\gws\Data);
	$app->setCatchExceptions(false);
	$app->run();
}
catch (\Infira\Error\Error $e)
{
	$out->writeln("General error: <error>" . br2nl($e->getMessage()) . "</error>");
	$out->writeln('<info>Trace</info>');
	foreach ($e->getStackTrace() as $key => $row)
	{
		$key++;
		$row['file'] = $row['file'] ?? '';
		$row['line'] = $row['line'] ?? '';
		$out->writeln($key . ') in file <info>' . $row['file'] . ' on line <info>' . $row['line'] . '</info>');
	}
}
catch (Throwable $e)
{
	$ie = $Handler->catch($e);
	$out->writeln("General error: <error>" . br2nl($ie->getMessage()) . "</error>");
	$out->writeln('<info>Trace</info>');
	foreach ($ie->getStackTrace() as $key => $row)
	{
		$key++;
		$row['file'] = $row['file'] ?? '';
		$row['line'] = $row['line'] ?? '';
		$out->writeln($key . ') in file <info>' . $row['file'] . ' on line <info>' . $row['line'] . '</info>');
	}
}